# Week 13：API 治理与稳定性工程

## 本周目标

补齐生产化 API 治理与稳定性能力，确保接口契约清晰、流量可控、服务可平滑发布与下线。

## 详细步骤

1. 定义统一响应结构与错误码规范（覆盖 400/401/403/404/409/429/500）。
2. 为核心接口补充 OpenAPI 文档（至少登录、Todo CRUD）。
3. 设计并实现至少 1 个写接口的幂等机制（如 `Idempotency-Key`）。
4. 为冲突场景补充 409 行为定义与测试（如重复提交）。
5. 实现限流中间件（按 IP 或用户维度）并返回统一 429 响应。
6. 为关键依赖调用补齐超时与重试策略，避免无限等待。
7. 实现服务优雅停机（`context` + `server.Shutdown`），验证进行中的请求可完成。
8. 组织一次最小故障演练（限流触发、依赖超时、滚动重启），并记录复盘。

## 建议实践清单

- 优先“先文档后实现”，减少接口返工。
- 幂等键要有过期策略，避免无限增长。
- 重试只用于可重试错误，避免放大故障。
- 限流与熔断策略需可配置，便于逐步调参。

## 验收清单

- [ ] 错误码与响应结构有统一规范文档。
- [ ] 核心接口有 OpenAPI 文档并可导入测试工具。
- [ ] 至少 1 个接口支持幂等并有回归测试。
- [ ] 限流策略可生效且返回 429。
- [ ] 服务支持优雅停机并有验证记录。
- [ ] 有一次稳定性故障演练与复盘结论。

## 产出物

- API 契约文档（错误码、响应结构、版本约定）。
- OpenAPI 文件与示例请求集合。
- 幂等、限流、优雅停机相关代码与测试。
- 稳定性演练记录与改进项清单。

## 常见风险与排查

- 只写文档不对齐实现：发布前做契约一致性检查。
- 幂等实现依赖客户端而服务端无兜底：服务端必须做重复请求识别。
- 限流误伤正常流量：先观测后收紧，保留白名单机制。
- 停机时直接强退导致请求丢失：必须先拒绝新请求再等待在途请求完成。
